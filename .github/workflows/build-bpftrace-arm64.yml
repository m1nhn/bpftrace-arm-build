name: Build bpftrace for Android (Native ARM64 - Tĩnh)

on: workflow_dispatch

jobs:
  build:
    runs-on: ubuntu-24.04-arm # Runner ARM64 xịn của bạn

    steps:
    - uses: actions/checkout@v4
      with:
        submodules: recursive

    # Bước 1: Build Image từ Dockerfile chính thức (Nó sẽ cài hết deps)
    - name: Build Builder Image (Alpine)
      id: build_image
      run: |
        # Dùng Dockerfile chính thức bạn vừa cung cấp
        docker build -t bpftrace-builder -f Dockerfile .
        # NOTE: Mình sẽ dùng image này để chạy lệnh compile custom

    # Bước 2: Chạy Container để Compile Tĩnh (Static)
    - name: Compile Static Binary
      run: |
        mkdir -p artifact
        
        # Chạy container đã cài đầy đủ tools (từ Alpine Dockerfile)
        docker run --rm \
          -v ${{ github.workspace }}:/code \
          -v ${{ github.workspace }}/artifact:/output \
          -w /code \
          bpftrace-builder \
          /bin/bash -c "
            # Tên thư mục Build
            mkdir build-android && cd build-android
            
            # CHỖ QUAN TRỌNG: Thêm cờ -DSTATIC_LINKING=ON để ép build tĩnh
            # (Các cờ khác giữ lại từ Dockerfile gốc để đảm bảo tương thích)
            cmake -B /code/build-android -G Ninja \
                  -DCMAKE_INSTALL_PREFIX=/usr \
                  -DCMAKE_BUILD_TYPE=MinSizeRel \
                  -DBUILD_TESTING=OFF \
                  -DCMAKE_PREFIX_PATH=/usr/lib/llvm20/lib/cmake \
                  -DLLVM_REQUESTED_VERSION=\"\$(/usr/lib/llvm20/bin/llvm-config --version)\" \
                  -DUSE_SYSTEM_LIBBPF=1 \
                  -DSTATIC_LINKING=ON \
                  ..
                  
            # Compile
            ninja -C /code/build-android -j\$(nproc)
            
            # Copy file ra ngoài
            cp src/bpftrace /output/bpftrace-arm64
            chmod +x /output/bpftrace-arm64
          "

    # Bước 3: Kiểm tra và Upload
    - name: Check binary and Upload
      run: |
        ls -lh artifact/
        file artifact/bpftrace-arm64
    
    - uses: actions/upload-artifact@v4
      with:
        name: bpftrace-android
        path: artifact/bpftrace-arm64
