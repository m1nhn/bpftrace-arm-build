name: BPFtrace Build on ARM64

on:
  push:
    branches:
      - main

jobs:
  build_arm64:
    name: Build on Ubuntu ARM64
    # Sử dụng runner arm64 theo yêu cầu
    runs-on: ubuntu-24.04-arm 

    env:
      LLVM_VERSION: 18 # Cập nhật: Ubuntu 24.04 thường ổn định với LLVM 18/19. 
                       # LLVM 20 có thể chưa có sẵn. Bạn cần kiểm tra lại.
      BUILD_DIR: /home/runner/work/bpftrace/build
      INSTALL_PREFIX: /usr

    steps:
      - name: Checkout Source Code
        uses: actions/checkout@v4
        with:
          path: src # Đặt mã nguồn vào thư mục /src giống như trong Dockerfile

      # 1. Cài đặt các Dependencies (Thay thế 'apk add' bằng 'apt-get install')
      # Lưu ý: Tên gói trên Alpine và Ubuntu là KHÁC NHAU.
      - name: Install Dependencies (apt)
        run: |
          sudo apt-get update
          # Package cơ bản tương đương build-base, bison, flex-dev
          sudo apt-get install -y build-essential bison flex 
          
          # CMAKE, Ninja (thay thế Samurai)
          sudo apt-get install -y cmake ninja-build 

          # LLVM/CLang (Sử dụng version được define)
          # Lưu ý: Thay thế clang$LLVM_VERSION-dev bằng clang-${LLVM_VERSION}
          sudo apt-get install -y \
            clang-${{ env.LLVM_VERSION }} \
            llvm-${{ env.LLVM_VERSION }}-dev \
            libclang-${{ env.LLVM_VERSION }}-dev \
            llvm-${{ env.LLVM_VERSION }}-tools \
            libxml2-dev \
            libelf-dev \
            libbpf-dev \
            asciidoctor \
            libcereal-dev \
            libbcc-dev \
            # blazesym thường được build kèm trong bpftrace, nếu không có trong repo 
            # bạn có thể cần build từ source hoặc tìm gói tương đương.
            # Với Ubuntu 24.04, thử tìm libblazesym-dev nếu cần:
            # libblazesym-dev 

      # 2. Tạo Symbolic Link (Replicate ln -s step)
      # Bước này có thể không cần thiết trên Ubuntu nếu LLVM được cài đặt chuẩn, 
      # nhưng ta vẫn thêm vào để đảm bảo CMAKE tìm thấy config.
      - name: Create LLVM Symlink
        run: |
          LLVM_CONFIG_PATH=/usr/lib/llvm-${{ env.LLVM_VERSION }}/bin/llvm-config
          if [ -f "$LLVM_CONFIG_PATH" ]; then
            echo "Found LLVM config at $LLVM_CONFIG_PATH"
          else
            echo "Warning: LLVM config not found at $LLVM_CONFIG_PATH. Build might fail."
            exit 1 # Thoát nếu không tìm thấy cấu hình LLVM
          fi
          # Tạo symlink tương đương: ln -s "clang${LLVM_VERSION}" /usr/lib/cmake/clang
          # (Bước này thường không cần thiết trên Ubuntu vì CMAKE tự tìm thấy)


      # 3. CMAKE Configure (Replicate RUN cmake -B /build ...)
      - name: CMAKE Configure
        working-directory: ${{ github.workspace }}/src
        run: |
          # Tìm đúng thư mục CMAKE config của LLVM
          LLVM_CMAKE_PATH="/usr/lib/llvm-${{ env.LLVM_VERSION }}/lib/cmake"
          LLVM_VERSION_STRING=$(/usr/lib/llvm-${{ env.LLVM_VERSION }}/bin/llvm-config --version)
          
          # Chạy lệnh CMAKE tương đương
          cmake -B ${{ env.BUILD_DIR }} -G Ninja \
            -DCMAKE_INSTALL_PREFIX=${{ env.INSTALL_PREFIX }} \
            -DCMAKE_BUILD_TYPE=MinSizeRel \
            -DBUILD_TESTING=OFF \
            -DCMAKE_PREFIX_PATH=${LLVM_CMAKE_PATH} \
            -DLLVM_REQUESTED_VERSION="${LLVM_VERSION_STRING}" \
            -DUSE_SYSTEM_LIBBPF=1

      # 4. CMAKE Build (Replicate RUN cmake --build /build ...)
      - name: CMAKE Build
        run: |
          cmake --build ${{ env.BUILD_DIR }} -j$(nproc)

      # 5. Kiểm tra kết quả
      - name: Test Build Output
        run: |
          echo "bpftrace executable is located at: ${{ env.BUILD_DIR }}/src/bpftrace"
          ls -l ${{ env.BUILD_DIR }}/src/bpftrace
