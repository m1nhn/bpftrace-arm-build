name: Build bpftrace (Official Flake + APT)

on:
  push:
    branches: [ "main", "master", "android-build" ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-24.04-arm # Runner ARM
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Äá»ƒ Nix xÃ¡c Ä‘á»‹nh version Ä‘Ãºng
          # DÃ¹ lá»‡nh Nix cÃ³ .?submodules=1, ta váº«n nÃªn checkout trÆ°á»›c cho cháº¯c
          submodules: recursive 

      - name: Install Nix (via APT)
        run: |
          echo "ğŸ“¦ Installing Nix..."
          sudo apt-get update
          sudo apt-get install -y nix-bin

          # --- QUAN TRá»ŒNG NHáº¤T ---
          # apt cÃ i /nix vá»›i quyá»n root, nhÆ°ng Github Runner cháº¡y user thÆ°á»ng.
          # Pháº£i chiáº¿m quyá»n thÆ° má»¥c /nix thÃ¬ lá»‡nh build má»›i cháº¡y Ä‘Æ°á»£c.
          sudo mkdir -p /nix
          sudo chown -R $USER /nix
          
          # Cáº¥u hÃ¬nh user local Ä‘á»ƒ báº­t Flakes
          mkdir -p ~/.config/nix
          echo "experimental-features = nix-command flakes" >> ~/.config/nix/nix.conf

      - name: Build bpftrace
        run: |
          echo "ğŸš€ Building..."
          # Lá»‡nh Ä‘Ãºng nhÆ° báº¡n yÃªu cáº§u
          nix build .?submodules=1# --extra-experimental-features "nix-command flakes" --print-build-logs

      - name: Verify Binary
        run: |
          echo "ğŸ” Checking binary type:"
          file result/bin/bpftrace
          # LÆ°u Ã½: Náº¿u output lÃ  "dynamically linked" thÃ¬ sáº½ khÃ´ng cháº¡y Ä‘Æ°á»£c trÃªn Android Ä‘Ã¢u nhÃ©.
          # NhÆ°ng cá»© build ra xem sao Ä‘Ã£.

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: bpftrace-build-result
          path: result/bin/bpftrace
