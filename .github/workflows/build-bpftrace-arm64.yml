name: Build bpftrace Android (Alpine)

on:
  push:
    branches: [ "main", "master", "android-build" ]
  workflow_dispatch:

jobs:
  build-alpine:
    runs-on: ubuntu-24.04-arm # Runner ARM xịn
    container: 
      image: alpine:edge # Dùng Alpine mới nhất (có LLVM 18/19)
    
    steps:
      - name: Install Dependencies
        run: |
          apk update
          # Cài các gói thư viện tĩnh (static) có sẵn, cực nhanh
          apk add git cmake make g++ linux-headers \
              bison flex \
              zlib-static \
              libelf-static \
              llvm19-static llvm19-dev \
              clang19-static clang19-dev \
              libbpf-dev \
              bcc-dev bcc-static \
              cereal

      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: recursive # Lấy full code

      - name: Build Static bpftrace
        run: |
          mkdir -p build
          cd build
          
          # Cấu hình CMake để ép liên kết tĩnh
          cmake -DCMAKE_BUILD_TYPE=Release \
                -DSTATIC_LINKING=ON \
                -DVENDOR_GTEST=OFF \
                -DBUILD_TESTING=OFF \
                ../
          
          # Biên dịch (dùng toàn bộ nhân CPU)
          make -j$(nproc) bpftrace

      - name: Check Binary
        run: |
          # Verify kết quả
          ls -lh build/src/bpftrace
          file build/src/bpftrace
          # Kết quả phải là: "statically linked"

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: bpftrace-android-arm64
          path: build/src/bpftrace
