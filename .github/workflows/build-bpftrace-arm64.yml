name: Build bpftrace Android (Alpine Docker)

on:
  push:
    branches: [ "main", "master", "android-build" ]
  workflow_dispatch:

jobs:
  build-alpine-docker:
    runs-on: ubuntu-24.04-arm # Cháº¡y trÃªn mÃ¡y áº£o Ubuntu (khÃ´ng lá»—i Node.js)
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Build inside Alpine Container
        run: |
          # 1. Táº¡o script build Ä‘á»ƒ cháº¡y bÃªn trong Alpine
          cat <<EOF > build_script.sh
          #!/bin/sh
          set -e
          
          echo "ðŸ“¦ Installing dependencies..."
          apk update
          apk add --no-cache git cmake make g++ linux-headers \
              bison flex zlib-static libelf-static \
              llvm19-static llvm19-dev clang19-static clang19-dev \
              libbpf-dev bcc-dev bcc-static cereal

          echo "ðŸ›  Configuring CMake..."
          mkdir -p build
          cd build
          cmake -DCMAKE_BUILD_TYPE=Release \
                -DSTATIC_LINKING=ON \
                -DVENDOR_GTEST=OFF \
                -DBUILD_TESTING=OFF \
                ..

          echo "ðŸš€ Building bpftrace..."
          make -j\$(nproc) bpftrace
          
          # Strip Ä‘á»ƒ giáº£m dung lÆ°á»£ng file
          strip bpftrace
          EOF

          chmod +x build_script.sh

          # 2. Cháº¡y Docker container alpine:edge
          # Mount thÆ° má»¥c hiá»‡n táº¡i ($PWD) vÃ o /work trong container
          docker run --rm -v "$PWD":/work -w /work alpine:edge ./build_script.sh

      - name: Check Artifact
        run: |
          # Kiá»ƒm tra file sau khi build xong
          ls -lh build/src/bpftrace
          file build/src/bpftrace
          # Káº¿t quáº£ pháº£i cÃ³ chá»¯: "statically linked"

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: bpftrace-android-arm64
          path: build/src/bpftrace
