name: Build bpftrace Android (ARM64)

on:
  push:
    branches: [ "main", "master", "android-build" ] # Chạy khi push vào các nhánh này
  workflow_dispatch: # Cho phép bấm nút chạy thủ công

jobs:
  build-static:
    runs-on: ubuntu-24.04-arm # Runner ARM miễn phí cho dự án công khai
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Build Static Docker Image
        # Lệnh này tìm Dockerfile.static ở thư mục gốc (.)
        run: docker build -t bpftrace-static -f Dockerfile.static .

      - name: Extract Binary
        run: |
          # Tạo container nhưng không chạy để copy file ra
          id=$(docker create bpftrace-static)
          docker cp $id:/build/src/bpftrace ./bpftrace-android-arm64
          docker rm -v $id
          chmod +x ./bpftrace-android-arm64

      - name: Verify Binary
        run: |
          file ./bpftrace-android-arm64
          # Kiểm tra xem có chữ "statically linked" không

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: bpftrace-android-arm64
          path: ./bpftrace-android-arm64
